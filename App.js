const express = require('express');
const axios = require('axios');
const { Groq } = require('groq-sdk');

const app = express();
const groq = new Groq({
    apiKey: process.env.GROQ_API_KEY
});

// Serve static files (CSS, images, etc.)
app.use(express.static('public'));

// Set up the route for the home page
app.get('/', (req, res) => {
    res.sendFile(__dirname + '/index.html');
});

// Route to fetch CVE data by CVE ID
app.get('/cve-data', async (req, res) => {
    try {
        const cveId = req.query.cveId;
        if (!cveId) {
            throw new Error('CVE ID is required');
        }
        const cveData = await fetchCVEData({ cveId });
        res.json(cveData);
    } catch (error) {
        console.error('Error fetching CVE data:', error);
        res.status(400).json({ error: error.message });
    }
});

// Route to get Groq chat completions
// Route to get Groq chat completions
app.get('/groq-completions', async (req, res) => {
    try {
        const cveId = req.query.cveId;
        if (!cveId) {
            throw new Error('CVE ID is required');
        }
        const cveData = await fetchCVEData({ cveId });
        const chatCompletion = await getGroqChatCompletion(cveData);
        const responseData = {
            system_response: "You are a helpful assistant. Analyze the CVE data and provide suggestions and mitigations",
            user_input: cveData.vulnerabilities[0]?.cve?.descriptions[0]?.value || 'No description available',
            model_response: chatCompletion.choices[0]?.message?.content || 'No chat completion available'
        };
        res.json(responseData);
    } catch (error) {
        console.error('Error getting Groq chat completions:', error);
        res.status(500).json({ error: 'Failed to get Groq chat completions' });
    }
});




async function fetchCVEData(params) {
    try {
        const response = await axios.get('https://services.nvd.nist.gov/rest/json/cves/2.0', { params });
        return response.data;
    } catch (error) {
        console.error('Error fetching CVE data:', error);
        throw new Error('Failed to fetch CVE data');
    }
}

async function getGroqChatCompletion(cveData) {
    try {
        // Extract the relevant data from cveData and format it appropriately
        const description = cveData.vulnerabilities[0]?.cve?.descriptions[0]?.value || 'No description available';
        const userMessage = `Analyze CVE data:\n${description}`;
        
        // Pass the relevant data to Groq for completion
        return groq.chat.completions.create({
            messages: [
                { role: "system", content: "You are a helpful assistant. Analyze the CVE data and provide suggestions and mitigations for the specific CVE." },
                { role: "user", content: userMessage }
            ],
            model: "mixtral-8x7b-32768"
        });
    } catch (error) {
        console.error('Error getting Groq chat completions:', error);
        throw new Error('Failed to get Groq chat completions');
    }
}

// Set up the Express server
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
    console.log(`Server is running on port ${PORT}`);
});
